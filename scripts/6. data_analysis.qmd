---
title: "Questioning the influence of roots: A soil fauna perspective on rhizosphere space"
format:
  html:
    css: css/styles.css  
    embed-resources: true
    theme: cosmo
    code-tools: true
    toc: true
    toc-depth: 4
execute: 
  warning: false
  message: false
  echo: false
---

## Executive Summary

This study investigates the spatial behavior of soil fauna in relation to root systems, challenging the notion of the rhizosphere as a simple, static attraction zone. By integrating null model simulations with Generalized Additive Models (GAMs), we decouple biological selection from physical habitat constraints and reveal that the demographic benefits of rhizosphere exploitation are governed by a distinct temporal lag.

## Setup and data preparation

```{r}
#| label: setup-env
Sys.setenv(CHROMOTE_CHROME_STARTUP_TIMEOUT = 120)
Sys.setenv(CHROMOTE_CHROME_ARGS = "--no-sandbox --disable-gpu --disable-dev-shm-usage")
# libraries
library(tidyverse)
library(mgcv)
library(broom)
library(gratia)
library(lubridate)
library(broom)
library(marginaleffects)
library(kableExtra)
library(DHARMa)
library(piecewiseSEM)
library(lme4)
library(webshot2)

# Global settings
set.seed(123)
if (!dir.exists("../output")) dir.create("../output")

# Ring surface function for density normalization
ring_surface <- function(r, width) {
  pi * ((r + width)^2 - r^2)}
# function to extract models results safely
safe_augment <- function(model, data, prefix) {
  df_new <- augment(model) %>%
    select(starts_with(".")) %>%
    rename_with(~ paste0(prefix, .))
  
  bind_cols(data, df_new)
}
```

```{r}
#| label: data-import
# Data Import & Alignment
habitat_data_raw <- read.csv("../output/distance_data_cleaned.csv") %>%
  mutate(date = parse_date_time(date, orders = c("Y-m-d H:M:S", "Y-m-d"), tz = "UTC"))

target_dates <- tibble(
  period = 1:7, 
  start_date = as.Date(c("2024-03-20", "2024-05-25", "2024-07-15", "2024-09-19", 
                         "2024-12-10", "2025-02-15", "2025-04-20"))
)

habitat_data_long <- habitat_data_raw %>%
  crossing(target_dates) %>%                
  filter(date >= start_date) %>%            
  group_by(date) %>%                         
  slice_max(start_date, n = 1) %>%           
  ungroup() %>%
  mutate(across(c(scanner, depth, period, position,orientation, Predicted.class.levelup, image_name), as.factor)) %>%
  select(scanner, image_name, temp, temp_soil_amplitude, hum, hum_soil_amplitude, invertebrate_count, predators_count, period, depth, position, orientation, Predicted.class.levelup, root_cm2_count,root_growth_cm2_count_24h,
         growth_obs = distance_root_growth_obs, 
         growth_exp = distance_root_growth_mean_exp, 
         growth_sd = distance_root_growth_sd_exp,
         mature_obs = distance_root_mature_obs, 
         mature_exp = distance_root_mature_mean_exp, 
         mature_sd = distance_root_mature_sd_exp) %>%
  pivot_longer(cols = starts_with(c("growth", "mature")), 
               names_to = c("root_type", ".value"), names_sep = "_") %>%
  mutate(z_score = (obs - exp) / sd) %>% 
  # filtering of extreme root density values
  filter(root_cm2_count >= quantile(root_cm2_count, 0.25, na.rm = TRUE) - 1.5 * IQR(root_cm2_count, na.rm = TRUE),root_cm2_count <= quantile(root_cm2_count, 0.25, na.rm = TRUE) + 1.5 * IQR(root_cm2_count, na.rm = TRUE)) %>%
  drop_na()

# Creation of an intra-specific invertebrate abundance variable
habitat_data_long <- habitat_data_long %>%
  group_by(image_name, Predicted.class.levelup, root_type) %>%
  mutate(abundance = sqrt(n())) %>%
  ungroup()
```

## 1. The rhizosphere effect: attraction and spatial signature

> To quantify habitat selection, we overlaid invertebrate occurrence data onto high-resolution root distance maps, calculating the distance from each individual’s centroid detection to the nearest root. We interpreted these distances within a Resource Selection Function (RSF) framework (Calenge *et al.* 2005). To characterize habitat availability, we projected 50 random points onto the corresponding root distance map for every invertebrate occurrence. We then derived the standardized marginality index (Z-score) by calculating the deviation of the observed distance from the mean null expected distance, scaled by the expected standard deviation. This index serves as a measure of spatial marginality: **negative values indicate active biological selection (attraction) of the rhizosphere, whereas positive values signify avoidance relative to a random spatial distribution**.

### *Do soil fauna actively select the rhizosphere space ?*

The central hypothesis of this study, which concerns the influence of roots on the spatial distribution of soil invertebrates, was first examined by testing for departures from random root-associated habitat use. Normalized marginality values were tested against zero using Wilcoxon signed-rank tests. Given the hypothesized functional specificities of organisms and root traits, these tests were conducted independently for each invertebrate taxon and root functional category.

```{r}
#| label: fig-global-attraction
#| fig-cap: "Rhizosphere Attraction Index"
#| fig-subcap:  "Negative Z-scores indicate active selection of the root zone"
#| fig-width: 5
#| fig-height: 4

# Statistical summary of Z-scores by Taxa and Root Type
rhizo_results <- habitat_data_long %>%
  group_by(Predicted.class.levelup, root_type) %>%
  summarise(
    n = n(),
    med_z = median(z_score, na.rm = TRUE), # Median of the normalized score
    p_val = wilcox.test(z_score, mu = 0)$p.value, # Test if Z is sig. different from 0
    .groups = "drop") %>%
  mutate(
    p_label = case_when(p_val < 0.001 ~ "***", p_val < 0.01 ~ "**", p_val < 0.05 ~ "*", TRUE ~ "ns"))

# Define background zones for visualization
bg_zones <- tibble(xmin = c(0, -Inf),xmax = c(Inf, 0),ymin = -Inf, ymax = Inf, zone = c("Avoidance","Selection"))

# Visualization of the Attraction Index
p1 <- habitat_data_long %>%
  filter(z_score >= quantile(z_score, 0.25, na.rm = TRUE) - 1.5 * IQR(z_score, na.rm = TRUE),
    z_score <= quantile(z_score, 0.25, na.rm = TRUE) + 1.5 * IQR(z_score, na.rm = TRUE)) %>%
  ggplot(aes(x = z_score, y = Predicted.class.levelup)) +
  geom_rect(data = bg_zones, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = zone), inherit.aes = FALSE, alpha = 0.15) +
  geom_jitter(alpha = 0.1, height = 0.1, color = "grey60") +
  geom_segment(data = rhizo_results, aes(y = Predicted.class.levelup, yend = Predicted.class.levelup, x = 0, xend = med_z),arrow = arrow(length = unit(0.20, "cm")), linewidth = 0.7, color = "#e50000") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed", linewidth = 0.8) +
  geom_text(data = rhizo_results, aes(x = med_z, y = Predicted.class.levelup, label = p_label), 
            vjust = -0.5, color = "black", size = 3, fontface = "bold") +
  facet_grid(root_type ~ .) +
  scale_fill_manual(values = c("Selection" = "#F1F4C6", "Avoidance" = "#AAA6A4"), guide = "none") +
  labs(x = "Standardized Attraction Index (Z-score)", 
       y = NULL) +
  theme_minimal() +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        strip.text = element_text(size = 10, face = "bold")) +
  annotate("text",
    x = Inf, y = Inf,
    label = "Avoidance",
    hjust = 1.1, vjust = 2,
    size = 3, fontface = "italic", color = "#999593") +
  annotate( "text",
    x = -Inf, y = Inf,
    label = "Selection",
    hjust = -0.1, vjust = 2,
    size = 3, fontface = "italic", color= "#c0c39e")


p1
tiff("../output/1.zscore_distribution.tiff", width = 1500, height = 1000, res = 250)
p1
invisible(dev.off())
```

The @fig-global-attraction reveals **significant, taxa-specific attraction to the root surface**, particularly for Collembola and Gastropoda. The strength of this selection varies by root type, suggesting that biological drivers - such as root exudation - shape spatial clustering beyond what is expected by chance.

### *Defining the rhizosphere width*

To delineate the precise spatial extent of root influence, we modeled invertebrate density as a function of root distance using Generalized Additive Models (GAMs) with a negative binomial distribution. To decouple biological selection from geometric bias – where soil volume increases quadratically with distance – a log-area offset as an exposure variable were incorporated. This effectively transformed raw counts into a density-based response. The rhizosphere width was defined as the distance where the first derivative of the spline first stabilized; specifically, where the 95% confidence interval of the slope included zero, indicating that animal density was no longer significantly influenced by root proximity.

```{r}
#| label: tbl-riz-extraction
#| tbl-cap: "rhizosphere width modelisation"
### 1. Data Binning and Geometric Area Correction 
max_dist <- 10
bin_w <- 0.1 #cm

# Calculate the number of animals per distance bin and the available area.
rhizo_decay_data <- habitat_data_long %>%
  # Filter out distances that are too large and biased by edge effects
  filter(obs <= max_dist) %>%
  # Create bins and assign observations to the midpoint of the bin
  mutate(dist_bin = floor(obs / bin_w) * bin_w + bin_w/2) %>%
  group_by(dist_bin, Predicted.class.levelup, root_type) %>%
  summarise(n_animals = n(), .groups = "drop") %>%
  # GEOMETRIC CORRECTION: Calculate the area of the concentric ring (annulus).
  # As distance (r) increases, the sampled area increases proportionally.
  # Area = pi * (R_outer^2 - R_inner^2)
  mutate(area = pi * ((dist_bin + bin_w/2)^2 - (dist_bin - bin_w/2)^2))

### 2. GAM Fitting and Derivative Analysis
extract_gam_stats <- function(df) {
  # Minimum data threshold to ensure model stability
  if (n_distinct(df$dist_bin) < 5 || sum(df$n_animals) < 10) return(NULL)
  
  # MODEL: Generalized Additive Model (GAM)
  # Family = quasipoisson
  # Offset = log(area): Treats the sampled area as an 'exposure' variable. 
  # This converts the raw count model into a density model (count/area) 
  # without the statistical pitfalls of using ratios directly.
  model <- tryCatch({
    gam(n_animals ~ s(dist_bin, k = 5), 
        offset = log(area), 
        data = df, 
        family = nb())
  }, error = function(e) return(NULL))
  
  if (is.null(model)) return(NULL)
  
  # RHIZOSPHERE IDENTIFICATION 
  # We use the first derivative (slope) of the model to find where 
  # the influence of the root stops (the plateau).
  eval_pts <- data.frame(dist_bin = seq(0.05, 10, length.out = 200))
  derivs <- derivatives(model, data = eval_pts, type = "forward")
  
  # STATISTICAL TIPPING POINT:
  # The RIZ is defined as the distance where the 95% Confidence Interval 
  # of the derivative first includes zero. At this point, the density 
  # slope is no longer significantly different from a horizontal line.
  riz_val <- derivs %>%
    mutate(lower = .derivative - 1.96 * .se,
           upper = .derivative + 1.96 * .se) %>%
    # Filter out the first 0.5cm to avoid noise near the root surface
    filter(dist_bin > 0.5, (lower < 0 & upper > 0) | lower > 0) %>% 
    slice(1) %>% 
    pull(dist_bin)
  
  #MODEL VALIDATION TESTS
  res <- simulateResiduals(model, n = 250, plot = FALSE)
  test_ks <- testUniformity(res, plot = FALSE)$p.value             # Distribution test
  test_disp <- testDispersion(res, plot = FALSE)$p.value # Surdispersion test
  test_out <- testOutliers(res, plot = FALSE)$p.value   # Outliers tests
  
  # RESULTS SUMMARY 
  tibble(
    edf = summary(model)$edf,             # Complexity of the curve (1 = linear)
    p_val = summary(model)$s.pv,          # Significance of the spatial pattern
    dev_expl = summary(model)$dev.expl * 100, # % of variance explained by root distance
    riz_cm = if(length(riz_val) > 0) riz_val else NA_real_, # Distance of influence
    n_total = sum(df$n_animals),           # Total count for the group
    check_ks = test_ks,     # If < 0.05, distribution shape problem
    check_disp = test_disp, # If < 0.05, overdispersion (justifies the quasi-Poisson distribution)
    check_out = test_out   # If < 0.05, too many outliers
  )
}

rhizo_stats_table <- rhizo_decay_data %>%
  group_by(Predicted.class.levelup, root_type) %>%
  do(extract_gam_stats(.))

# 3. Tabular Presentation
#| label: tbl-riz-width
n_rows_riz <- nrow(rhizo_stats_table)

t1 <- rhizo_stats_table %>%
  select(-check_ks, -check_disp, -check_out) %>%
  rename(
    Taxa = Predicted.class.levelup, 
    `Root Type` = root_type,
    `Complexity (EDF)` = edf, 
    `p-value` = p_val, 
    `Dev. Expl (%)` = dev_expl,
    `RIZ (cm)` = riz_cm, 
    `n total` = n_total
  ) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  mutate(
    # Highlight significant RIZ values (p < 0.05)
    `RIZ (cm)` = cell_spec(`RIZ (cm)`, bold = TRUE, 
                           color = ifelse(`p-value` < 0.05, "#D7261E", "black"))
  ) %>%
  kbl(booktabs = TRUE, align = "c", format = "html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("hover", "condensed"), position = "center", full_width = FALSE) %>%
  row_spec(0:nrow(rhizo_stats_table), background = "white") %>%
  # Uniform Border/Header Style
  row_spec(0, bold = TRUE, background = "#f2f2f2") %>%
  row_spec(0:n_rows_riz, extra_css = "border-bottom: 1px solid #dee2e6;") %>%
  # Highlight the key biological metric (RIZ)
  column_spec(6, background = "#f9f9f9") %>% 
  collapse_rows(columns = 1:2, valign = "top") 
t1 

invisible(save_kable(t1, file = "../output/2.rhizosphere_width.png", zoom = 3,  expand = 15))
```

## 2. The geometric niche: habitat availability constraint

```{r}
#| label: data-aggregation
# keep average values per scanner x period
habitat_data_reframe <- habitat_data_long %>% 
  group_by(scanner, period, Predicted.class.levelup, root_type) %>% 
  summarise(across(c(z_score, root_cm2_count, abundance), mean), .groups = "drop") 
```

### *Are fauna close to the root by choice (attraction) or necessity (habitat saturation) ?*

While attraction is a key driver, the physical presence of roots inherently constrains the available habitat. As root density increases, bulk soil volume diminishes, mathematically increasing the probability of fauna-root encounters regardless of biological preference. To isolate the true "biological signal," we modeled the $z$-score across a root density gradient. We utilized a Generalized Additive Model (GAM) with a Student-t (scat) distribution to account for the heavy-tailed nature of ecological distance data.

```{r}
#| label: geometric-constraint-model
# Modeling the gap (Obs - Exp) as a function of root density
mod_delta <- gam(
    z_score ~ Predicted.class.levelup + root_type +
    s(root_cm2_count,  by = interaction(root_type, Predicted.class.levelup,  drop = TRUE), k=5) + 
    s(period, bs = "re") + 
    s(scanner, bs = "re"),
  data = habitat_data_reframe, 
  family = scat(),
  method = "REML"
)

# Extract significance for plot annotation
s_tab <- as.data.frame(summary(mod_delta)$s.table) %>%
  tibble::rownames_to_column("smooth") %>%
  filter(grepl("root_cm2_count", smooth)) %>%
  mutate(
    p_label = cut(`p-value`, 
                  breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), 
                  labels = c("***", "**", "*", "ns")),
    group_str = gsub("s\\(root_cm2_count\\):interaction\\(root_type, Predicted.class.levelup, drop = TRUE\\)", "", smooth)
  ) %>%
  separate(group_str, into = c("root_type", "Predicted.class.levelup"), sep = "\\.")

# Augment data for plotting
habitat_delta <- safe_augment(mod_delta, habitat_data_reframe, "delta")
habitat_delta <- habitat_delta %>%
  select(-delta.sigma)%>%
  drop_na()
```

```{r}
#| label: fig-geometric-constraint
#| fig-cap: "Biological selection vs. geometric constraint"
#| fig-subcap: "Negative values represent active biological attraction beyond spatial probability"
#| fig-width: 8
#| fig-height: 6


p2 <-ggplot(habitat_delta, aes(x = root_cm2_count, y = delta.fitted)) +
  # Zero line as a baseline for "No Selection"
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey40", size = 0.5) +
  
  # Confidence Interval: Smoother transparency
  geom_ribbon(aes(ymin = delta.fitted - 2 * delta.se.fit, 
                  ymax = delta.fitted + 2 * delta.se.fit), 
              fill = "#002651", alpha = 0.15) +
  
  # Points: Reduced alpha to manage overlap in dense regions
  geom_point(aes(color = delta.fitted), size = 1.8, alpha = 0.6) +
  
  # Scale: Red = Strong Attraction (Biological Signal)
  scale_color_gradient2(low = "#5b0000", mid = "#e50000", high = "#f9cccc", 
                        midpoint = 0, guide = "none") +
  
  # Rug: Moved to bottom only for a cleaner look
  geom_rug(alpha = 0.1, color = "grey20", sides = "b") +
  
  # Significance: Better placement and size
  geom_text(data = s_tab, aes(x = Inf, y = -Inf, label = p_label),
            hjust = 1.5, vjust = -1.5, inherit.aes = FALSE, 
            size = 3.5, fontface = "bold.italic", color = "black") +
  
  facet_grid(root_type ~ Predicted.class.levelup, scales = "free_x") +
  
  # Labels: Scientific naming
  labs(x = expression(Root~Density~(cm^{2}*~count)), 
       y = "Standardized Selection Index (z-score)") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey80", fill = NA),
    strip.background = element_rect(fill = "#f7f7f7", color = NA),
    strip.text = element_text(face = "bold"),
    axis.title = element_text(face = "plain")
  )

p2
tiff("../output/3.geometric_constraint.tiff", width = 2200, height = 1400, res = 300)
p2
invisible(dev.off())
```

> Contrary to the expectation that increasing root density would force the selection index toward zero (random distribution), our results show that biological attraction is maintained or even intensified at higher root densities. For Acari and Collembola, the $z$-score remains consistently negative or shows a downward trend as root density increases, particularly in growth zones. This indicates that the rhizosphere effect is not a simple artifact of limited bulk soil space; rather, invertebrates actively 'seek out' the root surface even when roots are abundant. In Gastropoda, the selection index remains remarkably stable across the entire density gradient, suggesting a constant functional requirement for the rhizosphere regardless of how much root habitat is physically available.

## 3. The selection - demography link : trait or by-product ?

### *Is root selection a mechanical consequence of high population density or a functional driver of invertebrate success ?*

We tested two competing hypotheses to explain the relationship between spatial behavior and population dynamics: a mechanistic approach, which tests whether demographic processes dictate spatial behavior, and a functional approach, which tests whether the ability to locate and exploit roots leads to population growth.

#### **1. Mechanistic hypothesis: Do demographic processes dictate spatial behaviour?**

*"The intensity of root selection is a behavioural response constrained by population density (density dependence)."*

```{r}
#| label: mecanistic-approach
#| echo: true
mecanistic_model <- gam(delta.resid ~ Predicted.class.levelup + root_type + s(abundance, by =interaction(Predicted.class.levelup, root_type, drop=TRUE), k=10) + s(scanner, bs="re")+ s(period, bs="re"), family = gaussian(link = "identity"),  method = "REML", select = TRUE, data = habitat_delta)
```

#### **2. Functional approach : Does an organism's ability to locate and exploit the root result in an increase in its population?**

*As an "oasis" of resources (exudates, associated microflora, moisture), the root is not just a place where they happen to be, but a driver of their population dynamics. If a taxon is able to effectively 'select' roots (for mucus, exudates or microhabitats), it gains access to more energy, which promotes its reproduction and therefore its overall abundance.*

```{r}
#| label: functionnal approach
#| echo: true
functionnal_model <- gam(abundance ~ Predicted.class.levelup + root_type + s(delta.resid, by = interaction(Predicted.class.levelup, root_type, drop = TRUE), k=5) + s(scanner, bs="re")+ s(period, bs="re"), Gamma(link = "log"), method = "REML", select = TRUE, data = habitat_delta)
```

#### Models results comparison

To isolate biological signals from environmental noise, we partitioned the model deviance ($D^2$) into marginal $D^2$ (fixed biological predictors) and random $D^2$ (stochastic variation from scanner and period). We prioritized $D^2$ over traditional $R^2$ as it provides a robust, likelihood-based measure of fit for non-Gaussian Generalized Additive Models (GAMs).

```{r}
#| label: marginal-r2-calculation
# Final synthesis function
get_pub_table <- function(mech_mod, func_mod) {
  extract_stats <- function(mod, label) {
    # Full deviance
    total_d2 <- summary(mod)$dev.expl
    
    # Null model (Random effects + Fixed intercepts only)
    # Using the update logic we built earlier
    null_mod <- update(mod, . ~ Predicted.class.levelup + root_type + 
                         s(scanner, bs='re') + s(period, bs='re'))
    random_d2 <- summary(null_mod)$dev.expl
    
    data.frame(
      Hypothesis = label,
      Family = family(mod)$family,
      Total_D2 = scales::percent(total_d2, accuracy = 0.1),
      Random_effect_D2 = scales::percent(random_d2, accuracy = 0.1),
      Marginal_D2 = scales::percent(total_d2 - random_d2, accuracy = 0.1)
    )
  }
  
  bind_rows(
    extract_stats(mech_mod, "Mechanistic"),
    extract_stats(func_mod, "Functional")
  )
}
```

```{r}
#| label: tbl-demographic-results
#| tbl-cap: "Performance and Deviance Partitioning of Competing Hypotheses"

# 1. Generate the deviance partitioning metrics
final_metrics <- get_pub_table(mecanistic_model, functionnal_model)

# 2. Extract global fit stats using glance (AIC, Adj.R2)
global_stats <- bind_rows(
  glance(mecanistic_model) %>% mutate(Hypothesis = "Mechanistic"),
  glance(functionnal_model) %>% mutate(Hypothesis = "Functional")
) %>% 
  select(Hypothesis, adj.r.squared, AIC)

# 3. Join them into one final table
unified_table <- final_metrics %>%
  left_join(global_stats, by = "Hypothesis") %>%
  select(Hypothesis, Family, Total_D2, Marginal_D2, Random_effect_D2, adj.r.squared, AIC)

# 4. Render 
#| label: tbl-model-comparison
t2 <- unified_table %>%
  mutate(
    # Hypothesis and Marginal D2 get the primary thematic bolding
    Hypothesis = cell_spec(Hypothesis, bold = TRUE),
    Marginal_D2 = cell_spec(Marginal_D2, bold = TRUE, 
                            color = ifelse(grepl("Functional", Hypothesis), "#D7261E", "black"))
  ) %>%
  kable(
    format = "html",
    escape = FALSE,
    col.names = c("Hypothesis", "Family", "Total D²", "Marginal D²", "Random D²", "Adj. R²", "AIC"),,
    digits = 3,
    booktabs = TRUE, 
    align = "lcccccc"
  ) %>%
  kable_styling(bootstrap_options = c("hover", "condensed"), full_width = FALSE, position = "center") %>%
  row_spec(0:nrow(unified_table), background = "white") %>%
  # Header consistency with Table 1
  row_spec(0, bold = TRUE, background = "#f2f2f2") %>%
  add_header_above(c(" " = 2, "Deviance Partitioning (D²)" = 3, "Fit Statistics" = 2), bold = TRUE) %>%
  # Column highlighting (Column 4 is Marginal D2)
  column_spec(1, width = "150px") %>%
  column_spec(4, background = "#f9f9f9")

t2

invisible(save_kable(t2, file = "../output/4.deviance_partitioning.png", zoom = 2, 
           expand = 15))
```

> Statistical comparison via deviance partitioning (@tbl-demographic-results) strongly supports the Functional Hypothesis. While the Mechanistic model explained a negligible fraction of the variance (Marginal $D^2 = 2.0\%$), the Functional model accounted for $34.0\%$ of total deviance, with biological selection specifically explaining $11.1\%$. This indicates that for key soil taxa, the ability to locate and exploit root resources is a primary driver of population dynamics rather than a secondary consequence of crowding.

#### Functional drivers of invertebrate success

```{r}
#| label: fig-functional-results
#| fig-cap: "Demographic response to root selection intensity"
#| fig-width: 8
#| fig-height: 6

preds <- as.data.frame(predict(functionnal_model, newdata = habitat_delta, se.fit = TRUE))
habitat_results <- habitat_delta %>%
  mutate(
    fitted_abundance = exp(preds$fit),
    lower_ci = exp(preds$fit - 2 * preds$se.fit),
    upper_ci = exp(preds$fit + 2 * preds$se.fit)
  )

s_tab <- as.data.frame(summary(functionnal_model)$s.table) %>%
  tibble::rownames_to_column("smooth") %>%
  filter(grepl("delta.resid", smooth)) %>%
  mutate(
    p_label = cut(`p-value`, 
                  breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), 
                  labels = c("***", "**", "*", "ns")),
    clean_name = gsub("s\\(delta.resid\\):interaction\\(Predicted.class.levelup, root_type, drop = TRUE\\)", "", smooth)
  ) %>%
  separate(clean_name, into = c("Predicted.class.levelup", "root_type"), sep = "\\.", extra = "merge")


p3 <- ggplot(habitat_results, aes(x = delta.resid, y = fitted_abundance)) +
  # Vertical baseline for neutral selection
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey40", size = 0.5) +
  
  # CI Ribbon
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), 
              fill = "#002651", alpha = 0.15) +
  
  # Points: Synchronized color with the z-score plot
  geom_point(aes(color = delta.resid), size = 1.8, alpha = 0.6) +
  scale_color_gradient2(low = "#5b0000", mid = "#e50000", high = "#f9cccc", 
                        midpoint = 0, guide = "none") +
  
  geom_rug(alpha = 0.1, color = "grey20", sides = "b") +
  
  # Contextual annotations for the X-axis
  annotate("text", x = -1.5, y = Inf, label = "Attraction ←", 
           vjust = 2, size = 2.5, color = "grey40", fontface = "italic") +
  annotate("text", x = 1.5, y = Inf, label = "→ Avoidance", 
           vjust = 2, size = 2.5, color = "grey40", fontface = "italic") +
  
  geom_text(data = s_tab, aes(x = Inf, y = -Inf, label = p_label),
            hjust = 1.5, vjust = -1.5, inherit.aes = FALSE, 
            size = 3.5, fontface = "bold", color = "black") +
  
  facet_grid(root_type ~ Predicted.class.levelup, scales = "free_y") +
  
  labs(x = "Selection Intensity (Residual z-score)", 
       y = "Predicted Population Abundance") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey80", fill = NA),
    strip.background = element_rect(fill = "#f7f7f7", color = NA),
    strip.text = element_text(face = "bold"),
    plot.caption = element_text(size = 9, color = "grey30", margin = margin(t=10))
  )

p3
tiff("../output/5.functional-results.tiff", width = 2200, height = 1400, res = 300)
p3
invisible(dev.off())
```

> The back-transformed partial effects of the functional model (@fig-functional-results) visualize how specific taxa benefit from rhizosphere exploitation. Collembola exhibit the most pronounced functional link ($p < 0.01$); their predicted abundance increases exponentially as selection intensity for roots increases (indicated by more negative $z$-scores). In contrast, Acari and Gastropoda display largely neutral responses ($ns$). While these organisms are found within the rhizosphere, their population densities do not scale predictably with selection intensity, suggesting that their demographic success may be limited by other factors or that they occupy the root zone as transient habitat rather than a primary energy source.

---
title: "Questioning the influence of roots: A soil fauna perspective on rhizosphere space"
format:
  html:
    css: css/styles.css  
    embed-resources: true
    code-tools: true
    
execute: 
  warning: false
  message: false
  echo: false
---

## Setup and data preparation

```{r}
# Load core libraries
library(tidyverse)
library(mgcv)
library(broom)
library(gratia)
library(lubridate)
library(broom)
library(marginaleffects)
library(kableExtra)

# Global settings
set.seed(123)
if (!dir.exists("../output")) dir.create("../output")

# Ring surface function for density normalization
ring_surface <- function(r, width) {
  pi * ((r + width)^2 - r^2)}
```

```{r}
#| label: data-import
# Data Import & Alignment
habitat_data_raw <- read.csv("../output/distance_data_cleaned.csv") %>%
  mutate(date = parse_date_time(date, orders = c("Y-m-d H:M:S", "Y-m-d"), tz = "UTC")) %>%
  filter(position != "B")

target_dates <- tibble(
  period = 1:7, 
  start_date = as.Date(c("2024-03-20", "2024-05-25", "2024-07-15", "2024-09-19", 
                         "2024-12-10", "2025-02-15", "2025-04-20"))
)

habitat_data_long <- habitat_data_raw %>%
  crossing(target_dates) %>%                
  filter(date >= start_date) %>%            
  group_by(date) %>%                         
  slice_max(start_date, n = 1) %>%           
  ungroup() %>%
  mutate(across(c(depth, period, position, Predicted.class.levelup, image_name), as.factor)) %>%
  mutate(across(c(root_cm2_count, root_growth_cm2_count_24h, temp, temp_soil_amplitude, hum, hum_soil_amplitude, invertebrate_count, predators_count), ~ as.numeric(scale(.x)))) %>%
  select(image_name, temp, temp_soil_amplitude, hum, hum_soil_amplitude, invertebrate_count, predators_count, period, depth, position, Predicted.class.levelup, root_cm2_count,
         growth_obs = distance_root_growth_obs, 
         growth_exp = distance_root_growth_mean_exp, 
         growth_sd = distance_root_growth_sd_exp,
         mature_obs = distance_root_mature_obs, 
         mature_exp = distance_root_mature_mean_exp, 
         mature_sd = distance_root_mature_sd_exp) %>%
  pivot_longer(cols = starts_with(c("growth", "mature")), 
               names_to = c("root_type", ".value"), names_sep = "_") %>%
  mutate(z_score = (obs - exp) / sd) %>% 
  drop_na()
```

## 1. The Rhizosphere Effect: Attraction and Spatial Signature

#### ***Do soil fauna actively select the rhizosphere, or is their proximity to roots merely a by product of random distribution within a confined space?***

We employ a null model approach, comparing observed animal-to-root distances against simulated expected distances. We calculate a standardized Z-score ($Z = \frac{obs - exp}{sd}$) to represent the "Biological Signal" normalized by geometric standard deviation.

-   Negative Z-score: Active Selection (attraction).

-   Positive Z-score: Active Avoidance (repulsion).

-   Wilcoxon Test: Used to assess if the median Z-score significantly deviates from zero.

```{r}
#| label: global-attraction-plot
# Statistical summary of Z-scores by Taxa and Root Type
rhizo_results <- habitat_data_long %>%
  group_by(Predicted.class.levelup, root_type) %>%
  summarise(
    n = n(),
    med_z = median(z_score, na.rm = TRUE), # Median of the normalized score
    p_val = wilcox.test(z_score, mu = 0)$p.value, # Test if Z is sig. different from 0
    .groups = "drop") %>%
  mutate(
    p_label = case_when(p_val < 0.001 ~ "***", p_val < 0.01 ~ "**", p_val < 0.05 ~ "*", TRUE ~ "ns"))

# Define background zones for visualization
bg_zones <- tibble(xmin = c(0, -Inf),xmax = c(Inf, 0),ymin = -Inf, ymax = Inf, zone = c("Avoidance","Selection"))

# Visualization of the Attraction Index
habitat_data_long %>%
  filter(z_score >= quantile(z_score, 0.25, na.rm = TRUE) - 10 * IQR(z_score, na.rm = TRUE),
    z_score <= quantile(z_score, 0.25, na.rm = TRUE) + 10 * IQR(z_score, na.rm = TRUE)) %>%
  ggplot(aes(x = z_score, y = Predicted.class.levelup)) +
  geom_rect(data = bg_zones, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = zone), inherit.aes = FALSE, alpha = 0.15) +
  geom_jitter(alpha = 0.1, height = 0.1, color = "grey60") +
  geom_segment(data = rhizo_results, aes(y = Predicted.class.levelup, yend = Predicted.class.levelup, x = 0, xend = med_z),arrow = arrow(length = unit(0.20, "cm")), linewidth = 1.2, color = "#e50000") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed", size = 1.2) +
  geom_text(data = rhizo_results, aes(x = med_z, y = Predicted.class.levelup, label = p_label), 
            vjust = -0.5, color = "black", size = 5, fontface = "bold") +
  facet_grid(root_type ~ .) +
  scale_fill_manual(values = c("Selection" = "#F1F4C6", "Avoidance" = "#AAA6A4"), guide = "none") +
  labs(x = "Standardized Attraction Index (Z-score)", 
       y = NULL, 
       title = "Rhizosphere Attraction Index",
       subtitle = "Negative Z-scores indicate active selection of the root zone") +
  theme_minimal() +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        strip.text = element_text(size = 13, face = "bold"),
        axis.title.x = element_text(size = 12),
        title = element_text(size = 15, face = "bold"))
```

The analysis reveals a significant taxa-specific rhizosphere effect, with specific groups showing strong attraction (significant negative Z-scores) to the root surface. The strength of this selection varies by root type, suggesting that biological activity—likely root exudation—drives spatial clustering beyond what is expected by chance. Where Z-scores are non-significant, fauna distribution is governed by random movement and physical soil constraints rather than biological attraction.

#### Spatial Signature (RIZ Width)

Beyond global attraction, we identify the specific **Rhizosphere Influence Zone (RIZ)** by modeling animal density as a function of distance. Using Generalized Additive Models (GAM) and their first derivatives, we find the "tipping point" where animal density plateaus and the influence of the root vanishes.s.

```{r}
#| label: riz-extraction
### 1. Data Binning and Geometric Area Correction 
max_dist <- 10
bin_w <- 0.1 

# Calculate the number of animals per distance bin and the available area.
rhizo_decay_data <- habitat_data_long %>%
  # Filter out distances that are too large and biased by edge effects
  filter(obs <= max_dist) %>%
  # Create bins and assign observations to the midpoint of the bin
  mutate(dist_bin = floor(obs / bin_w) * bin_w + bin_w/2) %>%
  group_by(dist_bin, Predicted.class.levelup, position, root_type) %>%
  summarise(n_animals = n(), .groups = "drop") %>%
  # GEOMETRIC CORRECTION: Calculate the area of the concentric ring (annulus).
  # As distance (r) increases, the sampled area increases proportionally.
  # Area = pi * (R_outer^2 - R_inner^2)
  mutate(area = pi * ((dist_bin + bin_w/2)^2 - (dist_bin - bin_w/2)^2))

### 2. GAM Fitting and Derivative Analysis
extract_gam_stats <- function(df) {
  # Minimum data threshold to ensure model stability
  if (n_distinct(df$dist_bin) < 5 || sum(df$n_animals) < 10) return(NULL)
  
  # MODEL: Generalized Additive Model (GAM)
  # Family = quasipoisson
  # Offset = log(area): Treats the sampled area as an 'exposure' variable. 
  # This converts the raw count model into a density model (count/area) 
  # without the statistical pitfalls of using ratios directly.
  model <- tryCatch({
    gam(n_animals ~ s(dist_bin, k = 5), 
        offset = log(area), 
        data = df, 
        family = nb())
  }, error = function(e) return(NULL))
  
  if (is.null(model)) return(NULL)
  
  # RHIZOSPHERE INFLUENCE ZONE (RIZ) IDENTIFICATION 
  # We use the first derivative (slope) of the model to find where 
  # the influence of the root stops (the plateau).
  eval_pts <- data.frame(dist_bin = seq(0.05, 10, length.out = 200))
  derivs <- derivatives(model, data = eval_pts, type = "forward")
  
  # STATISTICAL TIPPING POINT:
  # The RIZ is defined as the distance where the 95% Confidence Interval 
  # of the derivative first includes zero. At this point, the density 
  # slope is no longer significantly different from a horizontal line.
  riz_val <- derivs %>%
    mutate(lower = .derivative - 1.96 * .se,
           upper = .derivative + 1.96 * .se) %>%
    # Filter out the first 0.5cm to avoid noise near the root surface
    filter(dist_bin > 0.5, (lower < 0 & upper > 0) | lower > 0) %>% 
    slice(1) %>% 
    pull(dist_bin)
  
  #MODEL VALIDATION TESTS
  res <- simulateResiduals(model, n = 250, plot = FALSE)
  test_ks <- testUniformity(res, plot = FALSE)$p.value             # Distribution test
  test_disp <- testDispersion(res, plot = FALSE)$p.value # Surdispersion test
  test_out <- testOutliers(res, plot = FALSE)$p.value   # Outliers tests
  
  # RESULTS SUMMARY 
  tibble(
    edf = summary(model)$edf,             # Complexity of the curve (1 = linear)
    p_val = summary(model)$s.pv,          # Significance of the spatial pattern
    dev_expl = summary(model)$dev.expl * 100, # % of variance explained by root distance
    riz_cm = if(length(riz_val) > 0) riz_val else NA_real_, # Distance of influence
    n_total = sum(df$n_animals),           # Total count for the group
    check_ks = test_ks,     # If < 0.05, distribution shape problem
    check_disp = test_disp, # If < 0.05, overdispersion (justifies the quasi-Poisson distribution)
    check_out = test_out   # If < 0.05, too many outliers
  )
}

rhizo_stats_table <- rhizo_decay_data %>%
  group_by(Predicted.class.levelup, position, root_type) %>%
  do(extract_gam_stats(.))
rhizo_stats_table
# 3. Tabular Presentation
n_rows <- nrow(rhizo_stats_table)
rhizo_stats_table %>%
  select(-check_ks, -check_disp, -check_out)%>%
  rename(taxa = Predicted.class.levelup, position = position, `root Type` = root_type,
         `complexity (EDF)` = edf, `p-value` = p_val, `dev. Expl (%)` = dev_expl,
         `RIZ (cm)` = riz_cm, `n total` = n_total) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  kbl(caption = "GAM Results: Identification of the Rhizosphere Influence Zone (RIZ)",
      booktabs = TRUE, align = "c") %>%
  kable_styling(bootstrap_options = c("hover", "condensed"), full_width = F, position = "center") %>%
  row_spec(0:n_rows,extra_css = "border-bottom: 2px solid #dee2e6;") %>%
  row_spec(1:n_rows, background = "white") %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2") %>%
  column_spec(5, color = spec_color(rhizo_stats_table$p_val, end = 0.1, direction = -1)) %>%
  column_spec(7, bold = T, border_left = "3px solid #b20000", border_right = "3px solid #b20000") %>%
  collapse_rows(columns = 1:3, valign = "top")
```

## 2. The Geometric Niche: Habitat Availability Constraint

#### ***Is fauna close to the root by choice (attraction) or necessity (lack of space)?***

A central challenge in rhizosphere ecology is determining whether fauna proximity to roots is driven by biological attraction or by geometric constraint (high root density limiting the available space). To disentangle these processes, we modeled the biological deviation ($Observed - Expected$) using a GAM with a Student-t (`scat`) family to robustly handle ecological outliers. This allows us to observe if the biological signal remains stable or is "masked" as the soil becomes saturated with roots.

```{r}
#| label: geometric-constraint-model
#| results: hide
#| fig-show: hide
# Modeling the gap (Obs - Exp) as a function of root density
mod_delta <- gam(
    (obs - exp) ~ Predicted.class.levelup + root_type +
    s(root_cm2_count,  by = interaction(root_type, Predicted.class.levelup,  drop = TRUE), k = 10) + 
    s(period, bs = "re") + 
    s(position, bs = "re")+
    s(depth, bs = "re"),
  data = habitat_data_long, 
  family = scat(),
  method = "REML"
)

# Check model performances
#gam.check(mod_delta, rep = 1000)
plot(DHARMa::simulateResiduals(mod_delta))

# Extract significance for plot annotation
s_tab <- as.data.frame(summary(mod_delta)$s.table) %>%
  tibble::rownames_to_column("smooth") %>%
  filter(grepl("root_cm2_count", smooth)) %>%
  mutate(
    p_label = cut(`p-value`, 
                  breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), 
                  labels = c("***", "**", "*", "ns")),
    group_str = gsub("s\\(root_cm2_count\\):interaction\\(root_type, Predicted.class.levelup, drop = TRUE\\)", "", smooth)
  ) %>%
  separate(group_str, into = c("root_type", "Predicted.class.levelup"), sep = "\\.")

# Augment data for plotting
habitat_delta <- augment(mod_delta, data = habitat_data_long)
```

```{r}
#| label: geometric-constraint-plot
ggplot(habitat_delta, aes(x = root_cm2_count, y = .fitted)) +
  geom_hline(yintercept = 0, 
             color = "black", size = 0.5, alpha = 0.3) +
  # The 95% Confidence Interval Envelope
  geom_ribbon(aes(ymin = .fitted - 1.96 * .se.fit, 
                  ymax = .fitted + 1.96 * .se.fit), 
              fill = "#b20000", alpha = 0.1) +
  # The Original Fitted Points: Points are colored if they represent active attraction 
  geom_point(aes(color = .fitted < 0), size = 1.5, alpha=0.5) +
  coord_cartesian(ylim = c(-2, 1))+
  # The Rug Plot (Shows data density on the X-axis)
  geom_rug(alpha = 0.5, color = "black") +
  # Significance Annotations
  geom_text(data = s_tab, aes(x = Inf, y = -Inf, label = paste("Significance:", p_label)),hjust = 1.5, vjust = -3, inherit.aes = FALSE, size=3,fontface = "bold") +
  
  facet_grid(root_type ~ Predicted.class.levelup, scales = "free") +
  # Styling
  scale_color_manual(values = c("TRUE" = "#e50000", "FALSE" = "#ffb2b2"), guide = "none") +
  labs(
    title = "Biological selection vs. geometric constraint",
    subtitle = "Negative values represent active biological attraction beyond spatial probability",
     x = "Root density scaled", y = "Obs − Exp Fitted Distance (cm)") +
  theme_minimal() +
  theme(panel.border = element_rect(color = "grey", fill = NA, linewidth = 0.5),
  panel.grid.minor = element_blank(),
  strip.background = element_rect(fill = "grey95", color = NA),
  strip.text = element_text(size = 12, face = "bold"),
  axis.title.x = element_text(size = 12),
  title = element_text(size=14))
```

#### Interpretation of Habitat Constraints

Our analysis reveals two distinct spatial strategies based on root functional part:

-   **Mature Roots (geometric saturation)**: We observe a clear convergence effect. While biological attraction is evident at low densities, the biological gap tends toward zero as root density increases. This suggests that in dense root systems, habitat availability "masks" active choice, as fauna effectively run out of space to exist far from a root.

-   **Growth Roots (persistent niche selection)**: For growing roots, biological attraction remains a persistent driver of distribution regardless of root density. This sustained preference indicates that the high biological value of growth zones—likely through quality exudation—overcomes the "noise" of increasing surface area. This allows for the detection of active niche selection across the entire density gradient.

## 3. Environmental Drivers: Presence vs. Selection

We disentangle whether climate affects Abundance (occupancy) or Distance Residuals (active behavior).

```{r}
# 1. Aggregate data by image
env_analysis_data <- habitat_data_long %>%
  group_by(image_name, Predicted.class.levelup, temp, hum, root_cm2_count, position, period, depth, root_type) %>%
  summarise(abundance = n(), mean_z_score = mean(z_score), .groups = "drop")

# 2. Baseline: Remove effect of abundance/density on distance
baseline_mod <- gam(mean_z_score ~ s(abundance, k=5) + s(root_cm2_count, k=5), data = env_analysis_data)
env_analysis_data$dist_residuals <- residuals(baseline_mod)

# 3. Compare Importance: Abundance (Filter) vs. Residuals (Selection)
mod_abund_imp <- gam(abundance ~ s(temp) + s(hum) + s(root_cm2_count), 
                     data = env_analysis_data, family = nb())
mod_behav_imp <- gam(dist_residuals ~ s(temp) + s(hum) + s(root_cm2_count), 
                     data = env_analysis_data)

# Extract and plot relative importance
imp_comp <- bind_rows(
  tidy(mod_abund_imp) %>% mutate(model = "Presence (Abundance)"),
  tidy(mod_behav_imp) %>% mutate(model = "Selection (Residuals)")
)

ggplot(imp_comp, aes(x = term, y = statistic, fill = model)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  labs(title = "Climate Importance: Presence vs. Selection", y = "F-statistic") +
  theme_minimal()
```
